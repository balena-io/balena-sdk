# We want to avoid unnecessary test runs, because they load the API, so:
# - we run tests for all changes in PRs
# - we run deploys for all version-tagged commits
# - we don't want to do anything for any other cases
# Travis has a bunch of filtering that's supposed to cover this sort of thing, but
# it doesn't quite work.

sudo: required
addons:
    chrome: stable

language: node_js
env:
  global:
    - secure: F/5yx2HHhh5V0yTQfwSIXvDjY821KQWOwg+dH8cidzwAeTDQwxt07X+2E+S0mY8ckyYEVDzATGHTJneuRblNeiSGhWBE6oaF5SaVYs5TEo12m/b4Vkt4H08kzwrHyZ5cHn3Q/Ukm3CAypcbwACRrioLtA3USj6cg5h6DXMSunmA=
    - RESINTEST_API_URL="https://api.resinstaging.io"
    - RESINTEST_USERNAME=pimterry
    - RESINTEST_EMAIL=pimterry@gmail.com
    - RESINTEST_USERID=480
matrix:
  include:
    - node_js:
      - '8'
      env:
      - 'CAN_DEPLOY=true'
before_install:
- npm -g install npm@4
script:
# Skip tests entirely, unless it's a pull request
# If we end up deploying, a deploy runs the tests anyway
- 'if [ "$TRAVIS_PULL_REQUEST" != "false" ]; then npm run ci; fi'

notifications:
  email: false
  webhooks:
    urls:
    - https://webhooks.gitter.im/e/8b150eaf525c280ec2ac
    on_success: change
    on_failure: always
    on_start: never
before_deploy:
- 'if [ "$CAN_DEPLOY" == "true" ]; then npm run ci; fi'
deploy:
  provider: npm
  email: 'accounts@resin.io'
  skip_cleanup: true
  api_key:
    secure: Sf3NkUEWA+YNwX2m4XuIPc8RxFAVa/TuUaD2lSGYn5fSPD7AFtWZKn24N3PVWbJjG8F8l6Zuwq+xgqxw4nrLLRvHsixZnxtpCRr7afyjnaUV4/UqUDgUgXlAKcbGlzObUPChZ/b2hGAkD5RtVvBmseVOFNAv2qUXv7ELuaRtML0=
  on:
    # Deploys happen if there's a tag, it's a version number, and this row in the matrix has '$CAN_DEPLOY'
    tags: true
    condition: $CAN_DEPLOY = 'true' && $TRAVIS_TAG =~ ^v?[[:digit:]]+\.[[:digit:]]+\.[[:digit:]]+
    repo: resin-io/resin-sdk
